- name: setup backend server
  hosts: all
  user: ubuntu
  tasks:
    - name: "upgrade packages."
      become: true
      apt:
        upgrade: "yes"

    - name: "install dependencies."
      become: true
      apt:
        name: ["nodejs", "npm"]
        state: latest
        update_cache: yes
    - name: "Set enviroment variables"
      shell: |
         export ENVIRONMENT=production
         export TYPEORM_CONNECTION=postgres
         export TYPEORM_ENTITIES=./src/modules/domain/**/*.entity.ts
         export TYPEORM_HOST={{TYPEORM_HOST}}
         export TYPEORM_PORT={{TYPEORM_PORT}}
         export TYPEORM_USERNAME={{TYPEORM_USERNAME}}
         export TYPEORM_PASSWORD={{TYPEORM_PASSWORD}}
         export TYPEORM_DATABASE={{TYPEORM_DATABASE}}
    - name: "Confirm enviroment"
      command: |
         echo TYPEORM_HOST=$TYPEORM_HOST
         echo TYPEORM_PORT=$TYPEORM_PORT
         echo TYPEORM_USERNAME=$TYPEORM_USERNAME
         echo TYPEORM_PASSWORD=$TYPEORM_PASSWORD
         echo TYPEORM_DATABASE=$TYPEORM_DATABASE

    - name: "install pm2"
      become: true
      npm:
        name: pm2
        global: yes
        production: yes
        state: present

    